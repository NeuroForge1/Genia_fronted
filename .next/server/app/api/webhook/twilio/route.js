(()=>{var e={};e.id=216,e.ids=[216],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1997:e=>{"use strict";e.exports=require("punycode")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},6487:()=>{},6621:(e,r,s)=>{"use strict";s.d(r,{ND:()=>t});let t=(0,s(6345).UU)("https://axfcmtrhsvmtzqqhxwul.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNtdHJoc3ZtdHpxcWh4d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4MjA2MzksImV4cCI6MjA1OTM5NjYzOX0.F7X3QI2AL90Q-XZjWceSuW45vDMBjz7txTqge4lwxtQ",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storageKey:"genia-auth-token"}})},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},9284:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>y,routeModule:()=>w,serverHooks:()=>f,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>b});var t={};s.r(t),s.d(t,{POST:()=>p});var a=s(6559),o=s(8088),n=s(7719),i=s(2190);!function(){var e=Error("Cannot find module 'twilio'");throw e.code="MODULE_NOT_FOUND",e}();class c{constructor(e,r,s){this.fromNumber=s,this.client=Object(function(){var e=Error("Cannot find module 'twilio'");throw e.code="MODULE_NOT_FOUND",e}())(e,r),this.fromNumber=s}async sendWhatsAppMessage(e){try{let r=await this.client.messages.create({body:e.body,from:`whatsapp:${this.fromNumber}`,to:`whatsapp:${e.to}`,mediaUrl:e.mediaUrl});return{success:!0,messageId:r.sid,status:r.status}}catch(e){return console.error("Error al enviar mensaje de WhatsApp:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}}async checkMessageStatus(e){try{let r=await this.client.messages(e).fetch();return{success:!0,status:r.status,dateCreated:r.dateCreated,dateSent:r.dateSent,dateUpdated:r.dateUpdated}}catch(e){return console.error("Error al verificar estado del mensaje:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}}async getMessageHistory(e,r=10){try{let s=await this.client.messages.list({to:`whatsapp:${e}`,limit:r});return{success:!0,messages:s.map(e=>({sid:e.sid,body:e.body,direction:e.direction,status:e.status,dateCreated:e.dateCreated,dateSent:e.dateSent}))}}catch(e){return console.error("Error al obtener historial de mensajes:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}}async processIncomingMessage(e,r){try{let s=e.replace("whatsapp:","");console.log(`Mensaje recibido de ${s}: ${r}`);let t=await this.sendWhatsAppMessage({to:s,body:`Hemos recibido tu mensaje: "${r}". Un clon de GENIA lo procesar\xe1 en breve.`});return{success:!0,messageId:t.messageId,status:t.status}}catch(e){return console.error("Error al procesar mensaje entrante:",e),{success:!1,error:e instanceof Error?e.message:"Error desconocido"}}}async verifyWhatsAppNumber(e){try{return await this.client.messages.create({body:"Verificaci\xf3n de n\xfamero de WhatsApp",from:`whatsapp:${this.fromNumber}`,to:`whatsapp:${e}`}),!0}catch(e){return console.error("Error al verificar n\xfamero de WhatsApp:",e),!1}}}function u(){let e=process.env.TWILIO_ACCOUNT_SID||"",r=process.env.TWILIO_AUTH_TOKEN||"",s=process.env.TWILIO_WHATSAPP_NUMBER||"";if(!e||!r||!s)throw Error("Faltan credenciales de Twilio en las variables de entorno");return new c(e,r,s)}var d=s(6621);async function p(e){try{let r=await e.formData(),s=r.get("From"),t=r.get("To"),a=r.get("Body"),o=r.get("MessageSid"),n=s.replace("whatsapp:",""),{error:c}=await d.ND.from("whatsapp_messages").insert({message_sid:o,from_number:n,to_number:t.replace("whatsapp:",""),body:a,direction:"inbound",status:"received"});c&&console.error("Error al guardar mensaje en la base de datos:",c);let{data:u,error:p}=await d.ND.from("profiles").select("user_id, plan").eq("phone_number",n).single();if(p||!u)return await l(n),i.NextResponse.json({success:!0,action:"welcome_sent"});let h=await m(a,u.user_id,u.plan,n);return i.NextResponse.json({success:!0,response:h})}catch(e){return console.error("Error al procesar webhook de Twilio:",e),i.NextResponse.json({success:!1,error:"Error al procesar webhook"},{status:500})}}async function l(e){try{let r=u(),s="\xa1Hola! Gracias por contactar a Genia. Para utilizar nuestros servicios, necesitas registrarte en nuestra plataforma: https://genia.app/register\n\nUna vez registrado, podr\xe1s vincular este n\xfamero de WhatsApp a tu cuenta y comenzar a utilizar nuestros clones de IA.";await r.sendWhatsAppMessage({to:e,body:s}),await d.ND.from("whatsapp_messages").insert({from_number:process.env.TWILIO_WHATSAPP_NUMBER||"",to_number:e,body:s,direction:"outbound",status:"sent"})}catch(e){console.error("Error al enviar mensaje de bienvenida:",e)}}async function m(e,r,s,t){try{let{data:a,error:o}=await d.ND.from("user_actions").select("count").eq("user_id",r).eq("action_type","whatsapp_message").gte("created_at",new Date(new Date().setDate(new Date().getDate()-30)).toISOString()).single(),n=0;switch(s){case"free":n=10;break;case"basic":n=100;break;case"pro":n=500;break;case"enterprise":n=999999;break;default:n=5}if((a?.count||0)>=n)return await h(t,s,n),{status:"limit_exceeded",plan:s,limit:n};let i="content";e.toLowerCase().includes("anuncio")||e.toLowerCase().includes("publicidad")?i="ads":e.toLowerCase().includes("estrategia")||e.toLowerCase().includes("negocio")?i="ceo":e.toLowerCase().includes("presentaci\xf3n")||e.toLowerCase().includes("hablar")?i="voice":e.toLowerCase().includes("ventas")||e.toLowerCase().includes("embudo")?i="funnel":(e.toLowerCase().includes("agenda")||e.toLowerCase().includes("tiempo"))&&(i="calendar");let c=`[Clon ${i}] Gracias por tu mensaje. En una implementaci\xf3n completa, este mensaje ser\xeda procesado por nuestro clon de IA especializado en ${i}.`,p=u();return await p.sendWhatsAppMessage({to:t,body:c}),await d.ND.from("whatsapp_messages").insert({from_number:process.env.TWILIO_WHATSAPP_NUMBER||"",to_number:t,body:c,direction:"outbound",status:"sent",clone_type:i}),await d.ND.from("user_actions").insert({user_id:r,action_type:"whatsapp_message",clone_type:i}),{status:"processed",clone:i}}catch(e){return console.error("Error al procesar mensaje:",e),{status:"error",error:e instanceof Error?e.message:"Error desconocido"}}}async function h(e,r,s){try{let t=u(),a=`Has alcanzado el l\xedmite de ${s} mensajes para tu plan ${r} en este mes. Para continuar utilizando nuestros servicios, considera actualizar tu plan: https://genia.app/subscription`;await t.sendWhatsAppMessage({to:e,body:a}),await d.ND.from("whatsapp_messages").insert({from_number:process.env.TWILIO_WHATSAPP_NUMBER||"",to_number:e,body:a,direction:"outbound",status:"sent"})}catch(e){console.error("Error al enviar mensaje de l\xedmite excedido:",e)}}let w=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/webhook/twilio/route",pathname:"/api/webhook/twilio",filename:"route",bundlePath:"app/api/webhook/twilio/route"},resolvedPagePath:"/home/ubuntu/genia/Genia_fronted/src/app/api/webhook/twilio/route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:g,workUnitAsyncStorage:b,serverHooks:f}=w;function y(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:b})}},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[447,580,345],()=>s(9284));module.exports=t})();