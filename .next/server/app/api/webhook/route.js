(()=>{var e={};e.id=717,e.ids=[717],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1630:e=>{"use strict";e.exports=require("http")},1645:e=>{"use strict";e.exports=require("net")},1997:e=>{"use strict";e.exports=require("punycode")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4075:e=>{"use strict";e.exports=require("zlib")},4631:e=>{"use strict";e.exports=require("tls")},4735:e=>{"use strict";e.exports=require("events")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5511:e=>{"use strict";e.exports=require("crypto")},5591:e=>{"use strict";e.exports=require("https")},6487:()=>{},6621:(e,r,t)=>{"use strict";t.d(r,{ND:()=>s});let s=(0,t(6345).UU)("https://axfcmtrhsvmtzqqhxwul.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4ZmNtdHJoc3ZtdHpxcWh4d3VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM4MjA2MzksImV4cCI6MjA1OTM5NjYzOX0.F7X3QI2AL90Q-XZjWceSuW45vDMBjz7txTqge4lwxtQ",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0,storageKey:"genia-auth-token"}})},7910:e=>{"use strict";e.exports=require("stream")},8335:()=>{},8480:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>m,serverHooks:()=>f,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>w});var s={};t.r(s),t.d(s,{POST:()=>p});var a=t(6559),o=t(8088),i=t(7719),n=t(2190),c=t(6621);!function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}();let u=Object(function(){var e=Error("Cannot find module 'stripe'");throw e.code="MODULE_NOT_FOUND",e}())(process.env.STRIPE_SECRET_KEY||"sk_test_your_default_key",{apiVersion:"2023-10-16"});async function p(e){try{let r,t=e.headers.get("stripe-signature"),s=await e.text();if(!t||!process.env.STRIPE_WEBHOOK_SECRET)return n.NextResponse.json({message:"Falta la firma de Stripe o el secreto del webhook"},{status:400});try{r=u.webhooks.constructEvent(s,t,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Error al verificar la firma del webhook:",e),n.NextResponse.json({message:"Error al verificar la firma del webhook"},{status:400})}switch(r.type){case"checkout.session.completed":{let e=r.data.object;await l(e);break}case"customer.subscription.updated":{let e=r.data.object;await d(e);break}case"customer.subscription.deleted":{let e=r.data.object;await _(e);break}default:console.log(`Evento no manejado: ${r.type}`)}return n.NextResponse.json({received:!0})}catch(e){return console.error("Error al procesar el webhook de Stripe:",e),n.NextResponse.json({message:"Error al procesar el webhook de Stripe"},{status:500})}}async function l(e){let r=e.metadata?.userId,t=e.subscription;if(!r||!t)return void console.error("Falta userId o subscriptionId en la sesi\xf3n de checkout");try{let e=await u.subscriptions.retrieve(t),s=e.items.data[0].price.id,a=e.items.data[0].price.product,o=await u.products.retrieve(a),i="free";o.name.toLowerCase().includes("b\xe1sico")||o.name.toLowerCase().includes("basic")?i="basic":o.name.toLowerCase().includes("pro")||o.name.toLowerCase().includes("profesional")?i="pro":(o.name.toLowerCase().includes("enterprise")||o.name.toLowerCase().includes("empresarial"))&&(i="enterprise");let{error:n}=await c.ND.from("subscriptions").upsert({user_id:r,stripe_subscription_id:t,stripe_customer_id:e.customer,stripe_price_id:s,status:e.status,plan:i,current_period_start:new Date(1e3*e.current_period_start).toISOString(),current_period_end:new Date(1e3*e.current_period_end).toISOString(),cancel_at_period_end:e.cancel_at_period_end});n&&console.error("Error al actualizar la suscripci\xf3n en Supabase:",n);let{error:p}=await c.ND.from("profiles").update({plan:i}).eq("user_id",r);p&&console.error("Error al actualizar el plan en el perfil del usuario:",p)}catch(e){console.error("Error al procesar la suscripci\xf3n completada:",e)}}async function d(e){try{let{data:r,error:t}=await c.ND.from("subscriptions").select("user_id").eq("stripe_subscription_id",e.id).single();if(t||!r)return void console.error("Error al buscar la suscripci\xf3n en Supabase:",t);let s=r.user_id,a=e.items.data[0].price.id,o=e.items.data[0].price.product,i=await u.products.retrieve(o),n="free";i.name.toLowerCase().includes("b\xe1sico")||i.name.toLowerCase().includes("basic")?n="basic":i.name.toLowerCase().includes("pro")||i.name.toLowerCase().includes("profesional")?n="pro":(i.name.toLowerCase().includes("enterprise")||i.name.toLowerCase().includes("empresarial"))&&(n="enterprise");let{error:p}=await c.ND.from("subscriptions").update({stripe_price_id:a,status:e.status,plan:n,current_period_start:new Date(1e3*e.current_period_start).toISOString(),current_period_end:new Date(1e3*e.current_period_end).toISOString(),cancel_at_period_end:e.cancel_at_period_end}).eq("stripe_subscription_id",e.id);p&&console.error("Error al actualizar la suscripci\xf3n en Supabase:",p);let{error:l}=await c.ND.from("profiles").update({plan:n}).eq("user_id",s);l&&console.error("Error al actualizar el plan en el perfil del usuario:",l)}catch(e){console.error("Error al procesar la actualizaci\xf3n de la suscripci\xf3n:",e)}}async function _(e){try{let{data:r,error:t}=await c.ND.from("subscriptions").select("user_id").eq("stripe_subscription_id",e.id).single();if(t||!r)return void console.error("Error al buscar la suscripci\xf3n en Supabase:",t);let s=r.user_id,{error:a}=await c.ND.from("subscriptions").update({status:e.status,cancel_at_period_end:e.cancel_at_period_end}).eq("stripe_subscription_id",e.id);if(a&&console.error("Error al actualizar la suscripci\xf3n en Supabase:",a),"canceled"===e.status){let{error:e}=await c.ND.from("profiles").update({plan:"free"}).eq("user_id",s);e&&console.error("Error al actualizar el plan en el perfil del usuario:",e)}}catch(e){console.error("Error al procesar la eliminaci\xf3n de la suscripci\xf3n:",e)}}let m=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/webhook/route",pathname:"/api/webhook",filename:"route",bundlePath:"app/api/webhook/route"},resolvedPagePath:"/home/ubuntu/genia/Genia_fronted/src/app/api/webhook/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:b,workUnitAsyncStorage:w,serverHooks:f}=m;function h(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:w})}},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},9428:e=>{"use strict";e.exports=require("buffer")},9551:e=>{"use strict";e.exports=require("url")}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[447,580,345],()=>t(8480));module.exports=s})();